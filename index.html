<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
<h1>Which Celebrity Do You Look Like
    In a Movie?</h1>
<input type="text" placeholder="Enter your favorite movie">
<button>Find out!</button>
<script>

	const container = document.createElement('div');
	document.body.append(container);
	const input = document.querySelector('input');
	const button = document.querySelector('button');
	let suggestedMovies;
	let movie;

	function throttle(func, ms) {
		let isThrottled = false,
			saveArgs,
			saveThis;

		function wrapper() {
			if (isThrottled) {
				saveArgs = arguments;
				saveThis = this;
				return;
			}

			func.apply(this, arguments);
			isThrottled = true;

			setTimeout(function () {
				isThrottled = false;
				if (saveArgs) {
					wrapper.apply(saveThis, saveArgs);
					saveArgs = saveThis = null;
				}
			}, ms);
		}

		return wrapper;
	}

	const searchMoviesWithThrottle = throttle((event) => {

		searchMovies(event.target.value)
			.then(response => {
				if (response.data.error !== undefined) {
					throw  new Error(`${response.data.error.info}`);
				}
				if (response.data.query.search.length > 0) {
					suggestedMovies = response.data.query.search;
					movie = suggestedMovies[0].title.split(' ').join('%20');
					console.log('suggested movies', suggestedMovies);
				}
			}).catch(error => {
			console.error(error);
			displayPageElem('p', error.message, container);
		});
	}, 700);


	input.addEventListener('input', searchMoviesWithThrottle);
	button.addEventListener('click', () => chooseActor(movie));


	function searchMovies(userInput) {
		return (
			axios.get(`https://en.wikipedia.org/w/api.php?action=query&list=search&format=json&origin=*&srsearch=${userInput}+incategory:English-language_Netflix_original_programming|English-language_films`)
		);
	}

	function isActorsDataExist(result) {
		const castMembersClaims = result.data.claims.P161;
		const voiceActorsClaims = result.data.claims.P725;
		if (castMembersClaims && castMembersClaims[0].mainsnak.snaktype === 'value') {
			return result.data.claims.P161;
		} else if (voiceActorsClaims && !(castMembersClaims && castMembersClaims[0].mainsnak.snaktype === 'value')) {
			return result.data.claims.P725;
		} else {
			const error = new Error('No actors data for this movie');
			error.name = 'NoActors';
			throw error;
		}
	}

	function chooseActor(movie) {
		clearPage(container);
		if (!movie) return;
		let actorsClaims;
		let castEntities;


		asyncGetWikidataItem(movie)
			.then(asyncGetCastMembersClaims)
			.then(result => {
				actorsClaims = isActorsDataExist(result);
				castEntities = actorsClaims.map(claim => claim.mainsnak.datavalue.value.id).join('|');
				if (actorsClaims.length > 50) {
					actorsClaims = actorsClaims.slice(0, 50);
				}
				return asyncGetCastMembersEntities(castEntities);
			})
			.then(asyncGetRandomCastMember)
			.then(result => asyncNameImageCharacter(result, actorsClaims))
			.then(results => displayCelebrity(results))
			.catch(err => {
				if (err.name === "NoActors") {
					displayPageElem('p',
						`Sorry, we dont't have enough information about the movie`, container);
					console.error(err);
				}
			});
	}

	const asyncGetWikidataItem = movie => {
		console.log('movie', movie);
		return (
			axios.get(`https://en.wikipedia.org/w/api.php?action=query&prop=pageprops&titles=${movie}&origin=*&format=json`)
		);
	};

	const asyncGetCastMembersClaims = result => {
		const wikidataItem = Object.values(result.data.query.pages)[0].pageprops.wikibase_item;
		console.log('movie', wikidataItem);
		return (
			axios.get(`https://www.wikidata.org/w/api.php?action=wbgetclaims&props=value&entity=${wikidataItem}&origin=*&format=json`)
		);
	};

	const asyncGetCastMembersEntities = result => {
		return (
			axios.get(`https://www.wikidata.org/w/api.php?action=wbgetentities&props=claims&languages=en&ids=${result}&origin=*&format=json`)
		);
	};

	const asyncGetRandomCastMember = result => {
		const castMembersWithPhotos = Object.values(result.data.entities).filter(item => item.claims.P18 !== undefined);
		const randomCastMember = Math.round(Math.random() * (castMembersWithPhotos.length - 1));
		return castMembersWithPhotos[randomCastMember].id;
	};

	const asyncGetCastMemberImage = memberId => {
		return (
			axios.get(`https://www.wikidata.org/w/api.php?action=wbgetclaims&property=P18&entity=${memberId}&origin=*&format=json`)
		);
	};

	const asyncGetCastMemberName = memberId => {
		return (
			axios.get(`https://www.wikidata.org/w/api.php?action=wbgetentities&props=labels&languages=en&ids=${memberId}&origin=*&format=json`)
		);
	};

	const asyncGetCastMemberCharacter = (memberId, castMembersClaims) => {
		const character = castMembersClaims.find(item => item.mainsnak.datavalue.value.id === memberId);
		if (character.qualifiers) {
			if (character.qualifiers.P453 !== undefined) {
				const characterId = character.qualifiers.P453[0].datavalue.value.id;
				return (
					axios.get(`https://www.wikidata.org/w/api.php?action=wbgetentities&props=labels&languages=en&ids=${characterId}&origin=*&format=json`)
				);
			} else if (character.qualifiers.P4633 !== undefined) {
				return Promise.resolve(character.qualifiers.P4633[0].datavalue.value);
			}
		}
		return null;
	};

	const asyncNameImageCharacter = (memberId, castMembersClaims) => {
		return Promise.all(
			[asyncGetCastMemberName(memberId),
				asyncGetCastMemberImage(memberId),
				asyncGetCastMemberCharacter(memberId, castMembersClaims)
			]);
	};

	const displayCelebrity = (results) => {
		//name
		const celebrityName = Object.values(results[0].data.entities)[0].labels.en.value;
		displayPageElem('h2', celebrityName, container);

		//image
		const celebrityImage = results[1].data.claims.P18[0].mainsnak.datavalue.value.split(' ').join("_");
		displayPageElem('img', celebrityImage, container);

		//character in movie
		let characterInMovie;
		if (typeof results[2] === 'string') {
			characterInMovie = results[2];
		} else if (results[2]) {
			characterInMovie = Object.values(results[2].data.entities)[0].labels.en.value;
		} else {
			characterInMovie = "";
		}
		displayPageElem('p', characterInMovie, container);
	};


	function displayPageElem(elem, content, parent) {
		const pageElem = document.createElement(elem);
		if (elem === 'img') {
			pageElem.src = `http://commons.wikimedia.org/wiki/Special:FilePath/${content}?width=300px`;
		} else {
			pageElem.innerHTML = content;
		}
		parent.append(pageElem);
	}

	function clearPage(parent) {
		while (parent.firstChild) {
			parent.firstChild.remove();
		}
	}
</script>
</body>

</html>
